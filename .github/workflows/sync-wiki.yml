# Syncs the wiki from the docs/ folder. No need to create the wiki repo manually;
# enable Wikis in Settings and add the WIKI_GITHUB_TOKEN secret.

name: Sync Docs to Wiki

on:
  push:
    paths:
      - 'docs/**'
      - '.github/workflows/sync-wiki.yml'
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Clone Wiki
        env:
          WIKI_TOKEN: ${{ secrets.WIKI_GITHUB_TOKEN }}
        run: |
          if [ -z "$WIKI_TOKEN" ]; then
            echo "::error::WIKI_GITHUB_TOKEN secret is not set. Add it under Repo Settings > Secrets and variables > Actions. See docs/ACTIVATION_GUIDE.md"
            exit 1
          fi
          git clone https://${WIKI_TOKEN}@github.com/kursadaltan/kemalwaf.wiki.git wiki || {
            echo "::error::Wiki clone failed. Please: 1) Enable 'Wikis' under Repo Settings > General > Features. 2) Open the Wiki tab and create the first page (this creates the wiki repo). 3) Re-run this workflow."
            exit 1
          }

      - name: Copy Documentation
        run: |
          cp docs/README.md wiki/Home.md
          cp docs/installation.md wiki/Installation.md
          cp docs/configuration.md wiki/Configuration.md
          cp docs/rules.md wiki/Rules.md
          cp docs/deployment.md wiki/Deployment.md
          cp docs/nginx-setup.md wiki/Nginx-Setup.md
          cp docs/tls-https.md wiki/TLS-HTTPS.md
          cp docs/api.md wiki/API-Reference.md
          cp docs/environment-variables.md wiki/Environment-Variables.md
          cp docs/GEOIP.md wiki/GeoIP-Filtering.md
          cat > wiki/_Sidebar.md << 'SIDEBAR'
          ## Getting Started
          - [[Home]]
          - [[Installation]]
          - [[Configuration]]

          ## Guides
          - [[Rules]]
          - [[Deployment]]
          - [[Nginx-Setup]]
          - [[TLS-HTTPS]]

          ## Reference
          - [[API-Reference]]
          - [[Environment-Variables]]
          - [[GeoIP-Filtering]]
          SIDEBAR

      - name: Update Wiki Links
        run: |
          cd wiki
          find . -name "*.md" -type f -exec sed -i 's|\.github/docs/||g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|docs/||g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(installation\.md)|(Installation)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(configuration\.md)|(Configuration)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(rules\.md)|(Rules)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(deployment\.md)|(Deployment)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(nginx-setup\.md)|(Nginx-Setup)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(tls-https\.md)|(TLS-HTTPS)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(api\.md)|(API-Reference)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(environment-variables\.md)|(Environment-Variables)|g' {} \;
          find . -name "*.md" -type f -exec sed -i 's|(geoip\.md)|(GeoIP-Filtering)|g' {} \;

      - name: Commit and Push to Wiki
        env:
          WIKI_TOKEN: ${{ secrets.WIKI_GITHUB_TOKEN }}
        run: |
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes in wiki, skipping push."
          else
            git commit -m "Sync docs from main repo - $(date -u +%Y-%m-%d)"
            git push https://x-access-token:${WIKI_TOKEN}@github.com/kursadaltan/kemalwaf.wiki.git HEAD:master
          fi
