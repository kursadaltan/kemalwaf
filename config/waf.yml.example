# Kemal WAF Configuration File
# Copy this file to waf.yml and edit the values

waf:
  # WAF mode: enforce, observe, disabled
  mode: enforce
  
  # Global default upstream (optional, for backward compatibility)
  # This is used if no domain-specific upstream exists
  upstream:
    url: http://localhost:8080
    timeout: 30s
    retry: 3
    
  # Multi-domain configuration with SNI (Server Name Indication) support
  # Each domain can have its own TLS certificate
  # Priority: custom cert_file/key_file > letsencrypt_enabled > global TLS config
  #
  # Automatic SSL Certificate Creation:
  # - At startup, WAF automatically creates Let's Encrypt certificates for domains with letsencrypt_enabled: true
  # - Certificates are stored in config/certs/letsencrypt/<domain>/
  # - Certificate renewal is checked every 12 hours, renewed 30 days before expiration
  # - If certificate creation fails, domain works in HTTP-only mode (HTTPS not available)
  # - Port 80 must be accessible for HTTP-01 challenge validation
  #
  domains:
    # Example 1: Domain with custom certificate files
    "example.com":
      default_upstream: "http://localhost:8080"
      upstream_host_header: "example.com"
      preserve_original_host: true
      # Custom TLS certificate for this domain (SNI)
      # cert_file: /etc/letsencrypt/live/example.com/fullchain.pem
      # key_file: /etc/letsencrypt/live/example.com/privkey.pem

    # Example 2: Domain with Let's Encrypt auto-certificate (RECOMMENDED)
    # WAF automatically obtains and renews SSL certificate from Let's Encrypt
    "api.example.com":
      default_upstream: "http://localhost:8081"
      upstream_host_header: "api.example.com"
      preserve_original_host: true
      verify_ssl: false  # Skip SSL verification for upstream
      # Let's Encrypt automatic certificate (HTTP-01 challenge)
      # Prerequisites:
      #   - DNS A record points to this server
      #   - Port 80 accessible from internet (for HTTP-01 challenge)
      #   - Valid email address for Let's Encrypt account
      letsencrypt_enabled: true
      letsencrypt_email: admin@example.com
      # Note: If certificate creation fails, domain will be served over HTTP only

    # Example 3: Subdomain with custom certificate
    "www.example.com":
      default_upstream: "http://localhost:8080"
      preserve_original_host: true
      # cert_file: /path/to/www.example.com/cert.pem
      # key_file: /path/to/www.example.com/key.pem
      
  # Rate limiting configuration
  rate_limiting:
    enabled: true
    default_limit: 250
    window: 1s
    block_duration: 60s
    
  # IP filtering configuration
  ip_filtering:
    enabled: true
    whitelist_file: config/ip_whitelist.txt
    blacklist_file: config/ip_blacklist.txt
    
  # GeoIP filtering configuration
  geoip:
    enabled: false
    mmdb_file: config/Maxmind/GeoLite2-Country.mmdb
    blocked_countries: []  # Example: [CN, RU, KP]
    allowed_countries: []   # If empty, all countries are allowed
    
  # Rules configuration
  rules:
    directory: rules/
    reload_interval: 5s
    
  # Logging configuration
  logging:
    level: info
    format: json
    audit_file: logs/audit.log
    log_dir: logs
    max_size_mb: 100
    retention_days: 30
    audit_max_size_mb: 50
    audit_retention_days: 90
    enable_audit: true
    queue_size: 10000
    batch_size: 100
    flush_interval_ms: 1000
    
  # Metrics configuration
  metrics:
    enabled: true
    port: 9090
    
  # Connection pooling configuration
  connection_pooling:
    enabled: true
    pool_size: 20         # Pool size for each upstream (optimized: first 10 created immediately)
    max_size: 100          # Max pool size
    idle_timeout: 300s    # Idle connection timeout
    health_check: true    # Connection health check
    
  # Server configuration (HTTP/HTTPS)
  server:
    http_enabled: true    # Enable HTTP server (default: true)
    https_enabled: false  # Enable HTTPS server (default: false)
    http_port: 3030       # HTTP port (default: 3030)
    https_port: 3443      # HTTPS port (default: 3443)
    http2_enabled: false  # HTTP/2.0 support (default: false, not yet implemented)
    
    # TLS/SSL configuration (required if https_enabled: true)
    tls:
      # Option 1: Use certificate files
      # cert_file: /path/to/cert.pem
      # key_file: /path/to/key.pem
      
      # Option 2: Auto-generate self-signed certificate (for testing/development only)
      auto_generate: false        # Auto-generate self-signed certificate (default: false)
      auto_cert_dir: config/certs # Directory for auto-generated certificates (default: config/certs)
      
      # TLS settings
      # tls_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"  # Optional: Custom cipher suite